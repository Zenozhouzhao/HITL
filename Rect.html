<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="js/jcanvas.min.js"></script>
    <script type="text/javascript" src="js/jquery.Jcrop.js"></script>
    <script type="text/javascript">
        jQuery(document).ready(function () {
            jQuery.getJSON("data/example_original.json", function (data) {
                var i = 0;
                jQuery.each(data, function (infoIndex, info) {
                    var tb = document.getElementById('data_tb');
                    var tr_node = document.createElement('tr');
                    tr_node.setAttribute('id', 'rect_' + i);
                    var td_id = document.createElement('td');
                    td_id.setAttribute('class', 'rect_id');
                    td_id.innerHTML = i;
                    tr_node.appendChild(td_id);
                    var td_x1 = document.createElement('td');
                    td_x1.setAttribute('class', 'rect_x1');
                    td_x1.innerHTML = info['bbox'][0][0];
                    tr_node.appendChild(td_x1);
                    var td_y1 = document.createElement('td');
                    td_y1.setAttribute('class', 'rect_y1');
                    td_y1.innerHTML = info['bbox'][0][1];
                    tr_node.appendChild(td_y1);
                    var td_x2 = document.createElement('td');
                    td_x2.setAttribute('class', 'rect_x2');
                    td_x2.innerHTML = info['bbox'][3][0];
                    tr_node.appendChild(td_x2);
                    var td_y2 = document.createElement('td');
                    td_y2.setAttribute('class', 'rect_y2');
                    td_y2.innerHTML = info['bbox'][3][1];
                    tr_node.appendChild(td_y2);
//                    for (var j = 1; j <= 4; j++) {
//                        var td_x = document.createElement('td');
//                        td_x.setAttribute('class', 'rect_x' + j);
//                        td_x.innerHTML = info['bbox'][j - 1][0];
//                        tr_node.appendChild(td_x);
//                        var td_y = document.createElement('td');
//                        td_y.setAttribute('class', 'rect_y' + j);
//                        td_y.innerHTML = info['bbox'][j - 1][1];
//                        tr_node.appendChild(td_y);
//                    }
                    for (var j = 1; j <= 3; j++) {
                        var td_content = document.createElement('td');
                        td_content.setAttribute('class', 'rect_content_' + j);
                        td_content.innerHTML = info['predicts'][j - 1]['content'];
                        tr_node.appendChild(td_content);
                        var td_score = document.createElement('td');
                        td_score.setAttribute('class', 'rect_score_' + j);
                        td_score.innerHTML = info['predicts'][j - 1]['score'];
                        tr_node.appendChild(td_score)
                    }
                    var td_content = document.createElement('td');
                    td_content.setAttribute('class', 'rect_content');
                    td_content.innerHTML = info['predicts'][0]['content'];
                    tr_node.appendChild(td_content);
                    tb.appendChild(tr_node);
                    i++;
                });
            });
        });
        window.onload = function () {
            var cvs = $.getId('img_cvs');
            var ctx = cvs.getContext('2d');
            var imgObj = new Image();
            imgObj.src = 'img/fapiao.jpg';
            imgObj.onload = function () {
                cvs.width = imgObj.naturalWidth;
                cvs.height = imgObj.naturalHeight;
                ctx.drawImage(imgObj, 0, 0, imgObj.naturalWidth, imgObj.naturalHeight);
                ctx.strokeStyle = "#FF0000";
                var tb = document.getElementById('data_tb');
                var all_rows = tb.rows;
                for (var i = 0; i < all_rows.length; i++) {
                    var x1 = all_rows[i].cells[1].innerHTML;
                    var y1 = all_rows[i].cells[2].innerHTML;
                    var w = all_rows[i].cells[3].innerHTML - x1;
                    var h = all_rows[i].cells[4].innerHTML - y1;
                    ctx.strokeRect(x1, y1, w, h)
                }
            };
        };
        var $ =
            {
                getId: function (_id) {
                    return document.getElementById(_id);
                }
            }
    </script>
    <script>
        function drawRect(x1, y1, x2, y2) {
            var jcrop_api;
            if (x1 != -1) {
                //                var jcrop_api;
                jQuery('#target').Jcrop({
                    onChange: showCoords,
                    onSelect: showCoords,
                    onRelease: clearCoords,
                    setSelect: [x1, y1, x2, y2]
                }, function () {
                    jcrop_api = this;
                });
                jQuery('#coords').on('change', 'input', function (e) {
                    var x_1 = $('#x1').val(),
                        x_2 = $('#x2').val(),
                        y_1 = $('#y1').val(),
                        y_2 = $('#y2').val();
                    jcrop_api.setSelect([x_1, y_1, x_2, y_2]);
                });
            }
            else {
                jQuery('#target').Jcrop({
                    onChange: showCoords,
                    onSelect: showCoords,
                    onRelease: clearCoords,
                    setSelect: [0,0,0,0]
                }, function () {
                    jcrop_api = this;
                });
                jQuery('#coords').on('change', 'input', function (e) {
                    var x_1 = $('#x1').val(),
                        x_2 = $('#x2').val(),
                        y_1 = $('#y1').val(),
                        y_2 = $('#y2').val();
                    jcrop_api.setSelect([x_1, y_1, x_2, y_2]);
                });
            }

            function showCoords(c) {
                jQuery('#x1').val(c.x);
                jQuery('#y1').val(c.y);
                jQuery('#x2').val(c.x2);
                jQuery('#y2').val(c.y2);
                jQuery('#w').val(c.w);
                jQuery('#h').val(c.h);
            };

            function clearCoords() {
                jQuery('#coords input').val('');
            };
        }
    </script>
    <link rel="stylesheet" href="css/jquery.Jcrop.css" type="text/css"/>
</head>
<body>
<div>
    <div style="float: left">
        <canvas id="img_cvs"></canvas>
        <div id="jcrop_div" class="container" style="display: none">
            <img src="img/fapiao.jpg" id="target" alt="[Jcrop Example]"/>
            <form id="coords"
                  class="coords"
                  onsubmit="return false;"
                  action="http://example.com/post.php">

                <div class="inline-labels">
                    <label>X1 <input type="text" size="4" id="x1" name="x1"/></label>
                    <label>Y1 <input type="text" size="4" id="y1" name="y1"/></label>
                    <label>X2 <input type="text" size="4" id="x2" name="x2"/></label>
                    <label>Y2 <input type="text" size="4" id="y2" name="y2"/></label>
                    <label>W <input type="text" size="4" id="w" name="w"/></label>
                    <label>H <input type="text" size="4" id="h" name="h"/></label>
                </div>
            </form>
            <div class="clearfix"></div>
        </div>
    </div>
    <div style="float: left;width: 50px">
        <br>
    </div>
    <div style="float:left;">
        <div>
            <button id="add_rect_btn" onclick="toAddRect()">添加框</button>
            <div id="add_rect_div" style="display: none;">
                <p>请画框并输入框内内容：</p>
                <input type="text" width="100px" id="add_rect_text">
                <button id="add_ok_btn" onclick="toAddOK()">确认添加</button>
                <button id="add_no_btn">取消添加</button>
            </div>
            <script>
                function toAddRect() {
                    var add_rect_div = document.getElementById('add_rect_div')
                    add_rect_div.style.display = ''
                    drawRect(-1, -1, -1, -1)
                    jQuery('#img_cvs').hide();
                    jQuery('#jcrop_div')[0].style.display = '';
                    var cvs = document.getElementById("img_cvs");
                    var imgUrl = cvs.toDataURL("image/png");
                    jQuery(".jcrop-holder img").attr("src", imgUrl)
                }

                function toAddOK() {
                    var tb = document.getElementById('data_tb');
                    var rect_id = tb.getElementsByClassName('rect_id')
                    var i = parseInt(rect_id[rect_id.length - 1].innerHTML) + 1
                    var tr_node = document.createElement('tr');
                    tr_node.setAttribute('id', 'rect_' + i);
                    var td_id = document.createElement('td');
                    td_id.setAttribute('class', 'rect_id');
                    td_id.innerHTML = i;
                    tr_node.appendChild(td_id);
                    var td_x1 = document.createElement('td');
                    td_x1.setAttribute('class', 'rect_x1');
                    td_x1.innerHTML = document.getElementById('x1').value;
                    tr_node.appendChild(td_x1);
                    var td_y1 = document.createElement('td');
                    td_y1.setAttribute('class', 'rect_y1');
                    td_y1.innerHTML = document.getElementById('y1').value;
                    tr_node.appendChild(td_y1);
                    var td_x2 = document.createElement('td');
                    td_x2.setAttribute('class', 'rect_x2');
                    td_x2.innerHTML = document.getElementById('x2').value;
                    tr_node.appendChild(td_x2);
                    var td_y2 = document.createElement('td');
                    td_y2.setAttribute('class', 'rect_y2');
                    td_y2.innerHTML = document.getElementById('y2').value;
                    tr_node.appendChild(td_y2);
                    var td_content = document.createElement('td');
                    td_content.setAttribute('class', 'rect_content');
                    td_content.innerHTML = document.getElementById('add_rect_text').value;
                    tr_node.appendChild(td_content);
                    tb.appendChild(tr_node);

                    jQuery('#img_cvs').show();
                    jQuery('#jcrop_div')[0].style.display = 'none';
                    var cvs = $.getId("img_cvs");
                    var ctx = cvs.getContext("2d");
                    ctx.clearRect(0, 0, cvs.width, cvs.height);
                    var imgObj = new Image();
                    imgObj.src = 'img/fapiao.jpg';
                    imgObj.onload = function () {
                        cvs.width = imgObj.naturalWidth;
                        cvs.height = imgObj.naturalHeight;
                        ctx.drawImage(imgObj, 0, 0, imgObj.naturalWidth, imgObj.naturalHeight);
                        ctx.strokeStyle = "#FF0000";
                        var tb = document.getElementById('data_tb');
                        var all_rows = tb.rows;
                        for (var i = 0; i < all_rows.length; i++) {
                            var x1 = all_rows[i].cells[1].innerHTML;
                            var y1 = all_rows[i].cells[2].innerHTML;
                            var w = all_rows[i].cells[3].innerHTML - x1;
                            var h = all_rows[i].cells[4].innerHTML - y1;
                            ctx.strokeRect(x1, y1, w, h)
                        }
                    }

                }
            </script>
        </div>
        <br>
        <div>
            <table>
                <tr>
                    <td><p>当前选择框：</p></td>
                    <td><P id="chose_rect_id">无</P></td>
                </tr>
                <tr>
                    <td>框内文本：</td>
                    <td><select id="chose_rect_text_sel"></select></td>
                </tr>
                <tr>
                    <td>如无正确答案，请自行填写：</td>
                    <td><input id="chose_rect_text_new" type="text" width="100px"></td>
                </tr>
                <tr>
                    <td>
                        <button id="edit_rect_btn" onclick="toEditRect()">修改框</button>
                        <script>
                            function toEditRect() {
                                var rectid = document.getElementById('chose_rect_id').innerHTML;
                                if (rectid == '无') {
                                    alert('请选择一个框！');
                                }
                                else {
                                    var con;
                                    con = confirm("确定修改？");
                                    if (con == true) {
                                        var tr = document.getElementById('rect_' + rectid)
                                        var x1 = tr.getElementsByClassName('rect_x1')[0].innerHTML
                                        var y1 = tr.getElementsByClassName('rect_y1')[0].innerHTML
                                        var x2 = tr.getElementsByClassName('rect_x2')[0].innerHTML
                                        var y2 = tr.getElementsByClassName('rect_y2')[0].innerHTML
                                        var edit_use_div = document.getElementById('edit_use_div')
                                        edit_use_div.style.display = ''
                                        drawRect(x1, y1, x2, y2)
                                        jQuery('#img_cvs').hide();
                                        jQuery('#jcrop_div')[0].style.display = '';
                                        var cvs = document.getElementById("img_cvs");
                                        var imgUrl = cvs.toDataURL("image/png");
                                        jQuery(".jcrop-holder img").attr("src", imgUrl)
                                    }
                                }
                            }
                        </script>
                    </td>
                    <td>
                        <div id="edit_use_div" style="display: none;">
                            <button id="edit_ok_btn" onclick="toEditOK()">确认修改</button>
                            <script>
                                function toEditOK() {
                                    var rectid = document.getElementById('chose_rect_id').innerHTML;
                                    var tr = document.getElementById('rect_' + rectid)
                                    var td_x1 = tr.getElementsByClassName('rect_x1')[0]
                                    var td_y1 = tr.getElementsByClassName('rect_y1')[0]
                                    var td_x2 = tr.getElementsByClassName('rect_x2')[0]
                                    var td_y2 = tr.getElementsByClassName('rect_y2')[0]
                                    td_x1.innerHTML = document.getElementById('x1').value;
                                    td_y1.innerHTML = document.getElementById('y1').value;
                                    td_x2.innerHTML = document.getElementById('x2').value;
                                    td_y2.innerHTML = document.getElementById('y2').value;

                                    jQuery('#img_cvs').show();
                                    jQuery('#jcrop_div')[0].style.display = 'none';
                                    var cvs = $.getId("img_cvs");
                                    var ctx = cvs.getContext("2d");
                                    ctx.clearRect(0, 0, cvs.width, cvs.height);
                                    var imgObj = new Image();
                                    imgObj.src = 'img/fapiao.jpg';
                                    imgObj.onload = function () {
                                        cvs.width = imgObj.naturalWidth;
                                        cvs.height = imgObj.naturalHeight;
                                        ctx.drawImage(imgObj, 0, 0, imgObj.naturalWidth, imgObj.naturalHeight);
                                        ctx.strokeStyle = "#FF0000";
                                        var tb = document.getElementById('data_tb');
                                        var all_rows = tb.rows;
                                        for (var i = 0; i < all_rows.length; i++) {
                                            var x1 = all_rows[i].cells[1].innerHTML;
                                            var y1 = all_rows[i].cells[2].innerHTML;
                                            var w = all_rows[i].cells[3].innerHTML - x1;
                                            var h = all_rows[i].cells[4].innerHTML - y1;
                                            ctx.strokeRect(x1, y1, w, h)
                                        }
                                    }
                                }
                            </script>
                            <button id="edit_no_btn">取消修改</button>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <button id="del_rect_btn" onclick="toDelRect()">删除框</button>
                        <script>
                            function toDelRect() {
                                var cvs = $.getId("img_cvs");
                                var ctx = cvs.getContext("2d");
                                var rectid = document.getElementById('chose_rect_id').innerHTML;
                                if (rectid == '无') {
                                    alert('请选择一个框！');
                                }
                                else {
                                    var con;
                                    con = confirm("确定删除？");
                                    if (con == true) {
                                        jQuery('#rect_' + rectid).remove();
                                        ctx.clearRect(0, 0, cvs.width, cvs.height);
                                        var imgObj = new Image();
                                        imgObj.src = 'img/fapiao.jpg';
                                        imgObj.onload = function () {
                                            cvs.width = imgObj.naturalWidth;
                                            cvs.height = imgObj.naturalHeight;
                                            ctx.drawImage(imgObj, 0, 0, imgObj.naturalWidth, imgObj.naturalHeight);
                                            ctx.strokeStyle = "#FF0000";
                                            var tb = document.getElementById('data_tb');
                                            var all_rows = tb.rows;
                                            for (var i = 0; i < all_rows.length; i++) {
                                                var x1 = all_rows[i].cells[1].innerHTML;
                                                var y1 = all_rows[i].cells[2].innerHTML;
                                                var w = all_rows[i].cells[3].innerHTML - x1;
                                                var h = all_rows[i].cells[4].innerHTML - y1;
                                                ctx.strokeRect(x1, y1, w, h)
                                            }
                                        }
                                    }
                                }
                            }
                        </script>
                    </td>
                    <td></td>
                </tr>
                <tr>
                    <td>请填写您的意见：</td>
                    <td><input id="user_suggest" type="text" width="100px"></td>
                </tr>
            </table>
        </div>
    </div>
</div>
<script>
    var cvs = $.getId("img_cvs");
    var ctx = cvs.getContext("2d");
    cvs.addEventListener('click', function (e) {
        var x = e.pageX;
        var y = e.pageY;
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        var imgObj = new Image();
        imgObj.src = 'img/fapiao.jpg';
        imgObj.onload = function () {
            cvs.width = imgObj.naturalWidth;
            cvs.height = imgObj.naturalHeight;
            ctx.drawImage(imgObj, 0, 0, imgObj.naturalWidth, imgObj.naturalHeight);
            ctx.strokeStyle = "#FF0000";
            var tb = document.getElementById('data_tb');
            var all_rows = tb.rows;
            for (var i = 0; i < all_rows.length; i++) {
                var x1 = all_rows[i].cells[1].innerHTML;
                var y1 = all_rows[i].cells[2].innerHTML;
                var w = all_rows[i].cells[3].innerHTML - x1;
                var h = all_rows[i].cells[4].innerHTML - y1;
                ctx.beginPath();
                ctx.rect(x1, y1, w, h);
                ctx.stroke();
                if (ctx.isPointInPath(x, y)) {
                    var select = $.getId('chose_rect_text_sel');
                    select.innerHTML = '';
                    for (var j = 5; j <= 9; j = j + 2) {
                        var option = document.createElement('option');
                        jQuery(option).val(all_rows[i].cells[j].innerHTML);
                        jQuery(option).text(all_rows[i].cells[j].innerHTML);
                        select.append(option)
                    }
                    document.getElementById('chose_rect_id').innerHTML = all_rows[i].cells[0].innerHTML
                }
            }
        }
    })
</script>
<div style="display: none">
    <table id="data_tb"></table>
</div>
</body>
</html>
